<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìŠµ ê¸°ë¡ - stweb</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        /* Tabs Style */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #1877f2;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #streak-message {
            font-size: 1.5em;
            font-weight: bold;
            color: #1877f2;
            text-align: center;
            margin-bottom: 20px;
        }

        #missed-days-list {
            list-style-type: none;
            padding: 0;
        }

        #missed-days-list li {
            background-color: #f7f7f7;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 1em;
            color: #606770;
            border-left: 4px solid #ccd0d5;
        }

        /* Manual Input Form Style */
        .manual-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #4b4f56;
            font-size: 0.9em;
        }

        input,
        select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .btn-submit {
            background: #1877f2;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-submit:hover {
            background: #166fe5;
        }

        /* Occupied Slots Style */
        .occupied-slots {
            margin-top: 20px;
            padding: 15px;
            background: #fff9e6;
            border-radius: 8px;
            border: 1px solid #ffeeba;
        }

        .occupied-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .slot-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .slot-item {
            background: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ffeeba;
            font-size: 0.85em;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
        }

        .home-link {
            display: block;
            text-align: center;
            margin-top: 30px;
            text-decoration: none;
            color: #1877f2;
            font-weight: bold;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            display: none;
            animation: fadeIn 0.3s;
        }

        .notification.success {
            background: #4caf50;
            display: block;
        }

        .notification.error {
            background: #f44336;
            display: block;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            display: block;
            width: fit-content;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ê³µë¶€ ê¸°ë¡ ê´€ë¦¬</h1>

        <div class="tabs">
            <button class="tab active" onclick="showTab('streak')">ğŸ”¥ í•™ìŠµ í˜„í™©</button>
            <button class="tab" onclick="showTab('manual')">âœï¸ ìˆ˜ë™ ì…ë ¥</button>
        </div>

        <!-- íƒ­ 1: í•™ìŠµ í˜„í™© -->
        <div id="streak-content" class="tab-content active">
            <div id="streak-message" class="loading">ë¡œë”© ì¤‘...</div>

            <h2>ê³µë¶€í•˜ì§€ ì•Šì€ ë‚ </h2>
            <ul id="missed-days-list">
                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </ul>
        </div>

        <!-- íƒ­ 2: ìˆ˜ë™ ì…ë ¥ -->
        <div id="manual-content" class="tab-content">
            <form class="manual-form" id="manual-form">
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="input-date" required>
                </div>

                <!-- ì´ë¯¸ ê¸°ë¡ëœ ì‹œê°„ëŒ€ í‘œì‹œ ì˜ì—­ -->
                <div id="occupied-slots-container" class="occupied-slots" style="display: none;">
                    <div class="occupied-title">âš ï¸ ì´ë¯¸ ê¸°ë¡ëœ ì‹œê°„ëŒ€</div>
                    <div class="slot-list" id="slot-list"></div>
                </div>

                <div class="form-group">
                    <label>ê³¼ëª©</label>
                    <select id="input-subject" required>
                        <option value="">ê³¼ëª© ì„ íƒ</option>
                    </select>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>ì‹œì‘ ì‹œê°„</label>
                        <input type="time" id="input-start" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>ì¢…ë£Œ ì‹œê°„</label>
                        <input type="time" id="input-end" required>
                    </div>
                </div>
                <button type="submit" class="btn-submit">ê¸°ë¡ ì™„ë£Œ</button>
                <button type="button" class="btn-delete" style="width: 100%; margin-top: 10px;"
                    onclick="handleDeleteLatest()">â†©ï¸ ë°©ê¸ˆ ì…ë ¥í•œ ê¸°ë¡ ì‚­ì œ</button>
            </form>
        </div>

        <a href="/" class="home-link">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadStreakInfo();
            loadSubjects();

            // 13:00 ~ 15:00 ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('input-start').value = "13:00";
            document.getElementById('input-end').value = "15:00";

            // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ê°’ ì„¤ì • (5AM ê¸°ì¤€)
            const now = new Date();
            if (now.getHours() < 5) {
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                document.getElementById('input-date').value = yesterday.toISOString().split('T')[0];
            } else {
                document.getElementById('input-date').value = now.toISOString().split('T')[0];
            }
            fetchOccupiedSlots(document.getElementById('input-date').value);

            // ë‚ ì§œ ë³€ê²½ ì‹œ ê¸°ì…ëœ ì‹œê°„ëŒ€ í™•ì¸
            document.getElementById('input-date').addEventListener('change', (e) => {
                fetchOccupiedSlots(e.target.value);
            });

            // ì‹œì‘ ì‹œê°„ ë³€ê²½ ì‹œ ì¢…ë£Œ ì‹œê°„ì„ 2ì‹œê°„ ë’¤ë¡œ ìë™ ì„¤ì •
            document.getElementById('input-start').addEventListener('change', (e) => {
                const startTime = e.target.value;
                if (startTime) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    let endHours = hours + 2;
                    if (endHours >= 24) endHours = 23; // ìƒí•œì„ 
                    const endStr = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    document.getElementById('input-end').value = endStr;
                }
            });

            // ìˆ˜ë™ ì…ë ¥ í¼ ì œì¶œ
            document.getElementById('manual-form').addEventListener('submit', handleManualSubmit);
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        async function loadStreakInfo() {
            try {
                const response = await fetch('/api/streak-info');
                const data = await response.json();

                const streakMessageEl = document.getElementById('streak-message');
                streakMessageEl.textContent = data.message;
                streakMessageEl.classList.remove('loading');

                const missedDaysListEl = document.getElementById('missed-days-list');
                missedDaysListEl.innerHTML = '';

                if (data.missed_days && data.missed_days.length > 0) {
                    data.missed_days.forEach(day => {
                        const li = document.createElement('li');
                        li.textContent = `${day} ê³µë¶€ë¥¼ í•˜ì§€ ì•Šìœ¼ì…¨ìŠµë‹ˆë‹¤`;
                        missedDaysListEl.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'ë¹ ì§ì—†ì´ ê³µë¶€í•˜ì…¨ë„¤ìš”. ì™„ë²½í•´ìš”!';
                    missedDaysListEl.appendChild(li);
                }
            } catch (error) {
                console.error('Error fetching streak info:', error);
                document.getElementById('streak-message').textContent = 'ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
        }

        async function loadSubjects() {
            try {
                const response = await fetch('/api/subjects');
                const subjects = await response.json();
                const select = document.getElementById('input-subject');

                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Failed to load subjects:', err);
            }
        }

        async function fetchOccupiedSlots(date) {
            try {
                const response = await fetch(`/api/sessions/${date}`);
                const sessions = await response.json();

                const container = document.getElementById('occupied-slots-container');
                const list = document.getElementById('slot-list');
                list.innerHTML = '';

                if (sessions.length > 0) {
                    container.style.display = 'block';
                    sessions.forEach(s => {
                        const start = s.start_time.split(' ')[1].substring(0, 5);
                        const end = s.end_time.split(' ')[1].substring(0, 5);
                        const item = document.createElement('div');
                        item.className = 'slot-item';
                        item.style.display = 'flex';
                        item.style.alignItems = 'center';
                        item.style.gap = '10px';

                        item.innerHTML = `
                            <span>${start} ~ ${end} (${s.subject})</span>
                            <button onclick="handleDeleteSession(${s.id})" style="border:none; background:none; color:#f44336; cursor:pointer; font-weight:bold; padding:0 5px;">âœ•</button>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    container.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to fetch occupied slots:', err);
            }
        }

        async function handleManualSubmit(e) {
            e.preventDefault();

            const date = document.getElementById('input-date').value;
            const subject = document.getElementById('input-subject').value;
            const startTimeStr = document.getElementById('input-start').value;
            const endTimeStr = document.getElementById('input-end').value;

            if (!startTimeStr || !endTimeStr) {
                showNotification('ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ë‚ ì§œì™€ ì‹œê°„ì„ í•©ì³ì„œ timestamp ìƒì„±
            const start = new Date(`${date}T${startTimeStr}`).getTime() / 1000;
            const end = new Date(`${date}T${endTimeStr}`).getTime() / 1000;
            const duration = end - start;

            if (duration <= 0) {
                showNotification('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // 5AM ì´ì „ ê¸°ë¡ì¸ ê²½ìš° 'ê³µë¶€ ë‚ ì§œ'ë¥¼ ì „ë‚ ë¡œ ì¡°ì • (ì‹œìŠ¤í…œ ì¼ì¹˜ì„±)
            let studyDate = date;
            const hour = parseInt(startTimeStr.split(':')[0]);
            if (hour < 5) {
                const d = new Date(date);
                d.setDate(d.getDate() - 1);
                studyDate = d.toISOString().split('T')[0];
            }

            try {
                const response = await fetch('/api/record-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: studyDate,
                        subject,
                        start_time: start,
                        end_time: end,
                        duration
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    // í¼ ì´ˆê¸°í™” ë° ë°ì´í„° ê°±ì‹ 
                    e.target.reset();
                    document.getElementById('input-date').value = date;
                    document.getElementById('input-start').value = "13:00";
                    document.getElementById('input-end').value = "15:00";
                    fetchOccupiedSlots(date);
                    loadStreakInfo();
                } else {
                    showNotification(result.error || result.message || 'ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                console.error('Failed to submit manual session:', err);
                showNotification('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function handleDeleteSession(id) {
            if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/delete-session/${id}`, { method: 'POST' });
                if (response.ok) {
                    showNotification('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchOccupiedSlots(document.getElementById('input-date').value);
                    loadStreakInfo();
                } else {
                    showNotification('ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('ì„œë²„ ì˜¤ë¥˜', 'error');
            }
        }

        async function handleDeleteLatest() {
            if (!confirm('ê°€ì¥ ìµœê·¼ì— ì…ë ¥í•œ ê¸°ë¡ í•˜ë‚˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/delete-latest-session', { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    showNotification(result.message, 'success');
                    fetchOccupiedSlots(document.getElementById('input-date').value);
                    loadStreakInfo();
                } else {
                    showNotification(result.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                console.error(err);
                showNotification('ì„œë²„ ì˜¤ë¥˜', 'error');
            }
        }

        function showNotification(message, type) {
            const n = document.getElementById('notification');
            n.textContent = message;
            n.className = `notification ${type}`;
            setTimeout(() => { n.className = 'notification'; }, 3000);
        }
    </script>
</body>

</html>